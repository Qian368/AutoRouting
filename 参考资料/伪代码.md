# ============================================
# "四步法"构建回路导线布局 - 伪代码
# 基于物理网络图，包含交互式单元定义
# ============================================

### 一、主要数据结构定义：
# ---------- 基础枚举定义 ----------
枚举 节点类型 {
    配电箱,     # 电源起点
    开关,       # 控制节点
    灯具,       # 受控设备
    插座,       # 非受控设备
    接线盒      # 纯连接节点
}

枚举 导线类型 {
    N,          # 零线
    PE,         # 保护地线
    L_单元,     # 单元内部并联火线
    L_控制,     # 控制线（从单元到开关）
    L_电源      # 电源线（从电源点到开关或从非受控单元到配电箱）
}

# ---------- 核心数据结构 ----------
导线对象 = {
    id: 字符串,                   # 自动生成编号，如"W0001"
    类型: 导线类型,
    路径: [导管对象列表],         # 该导线依次穿过的导管段
    颜色: 字符串                  # 用于图纸标注，如"红色", "蓝色"
    所属单元id: 字符串,            # 编号，如"U001"
    所属回路系统id: 字符串,        # 编号，如"回路001"
    导线电流: 数值                # 默认为0，基于节点额定电流计算
}

导管对象 = {
    id: 字符串,                   # 自动生成编号，如"CT0001"
    起点: 节点对象,
    终点: 节点对象,
    长度: 数值,                   # 基于节点位置计算
    穿行导线: [导线对象列表]      # 记录本段导管内所有导线
}

节点对象 = {
    id: 字符串,                   # 自动生成编号，如"N001", "SW1", "L1"
    类型: 节点类型,
    位置: (x, y, z),              # 三维坐标，用于计算距离
    连接的导管: [导管对象列表],   # 与该节点相连的所有导管
    连接的导线: [导线对象列表],   # 与该节点相连的所有导线
    标签: 字符串,                 # 用户定义的标识，如"客厅主灯"
    
    # 设备特定属性（根据节点类型选择性设置）
    联数: 整数 或 null,           # 仅用于开关节点，表示几联开关（1,2,3,...）
    额定功率: 数值 或 null,       # 用于电器节点
    额定电流: 数值,                # 默认为 0，计算导线电流的基础
    用途: 字符串 或 null,         # 描述信息
    
    # 单元关联信息
    所属受控单元: 单元对象 或 null,
    所属非受控单元: 单元对象 或 null
}

单元对象 = {
    id: 字符串,                   # 自动生成编号，如"U001"
    名称: 字符串,                 # 用户定义的单元名称，如"客厅照明组"
    类型: "受控" 或 "非受控",
    描述: 字符串,                 # 单元功能描述
    
    # 单元组成
    成员节点: [节点对象列表],     # 单元包含的节点
    控制开关: 节点对象 或 null,   # 仅用于受控单元，指向控制它的开关节点
    开关按键索引: 整数 或 null,   # 仅用于受控单元，表示对应开关的哪个按键（1,2,3,...）
    
    # 布线信息
    内部路径: [导管对象列表] 或 null,  # 连接单元内所有成员节点的最小生成树
    电源接入点: 节点对象 或 null       # 距离开关或配电箱最近的节点
}

回路系统 = {
    id: 字符串,               # 自动生成编号，如"回路001"
    配电箱节点: 节点对象,
    所有节点: [节点对象列表],
    所有导管: [导管对象列表],
    
    # 单元管理
    受控单元集合: [单元对象列表],
    非受控单元: 单元对象 或 null,
    
    # 系统配置
    导线颜色配置: 字典,           # 导线类型到颜色的映射
    安全规范: 字典               # 安全规范配置
}

### 二、用户预处理：
1、定义回路个数：如果一个图面有仅有一个配电箱节点，可跳过回路定义步骤。如果有多个配电箱节点，则需要用户定义回路
2、定义受控单元：先定义若干个受控单元（受控单元1、2...）并指定受控单元匹配对应对应n联开关节点的第x联（x≤n）。
3、定义非受控单元：定义剩余电器为非受控单元。

### 三、自动敷设导管流程（执行前先确认，用户预处理情况）：
1、将所有除了开关节点以外的所有节点采用最小生成树敷设导管。
2、遍历每个受控单元：找每个受控单元距离其匹配的开关节点的单元内节点敷设导管**(导管重叠时，应当去重)**。

### 四、自动敷设导线流程（执行前先确认，用户预处理情况）：
对于每个回路：
{
    **第一步：**
    1、对所有导管（排除导管端点为开关的）敷设地线和零线。
    2、每个电器节点（即排除除开关、配电箱节点）沿着地线向其配电箱节点找最短路径。在最短路径中，每段导线的电流 = 原导线电流 + 本电器节点的额定电流。
    **第二步：**
    对于非受控单元：
    1、非受控单元，同理和配电箱节点（即把配电箱节点添加到非受控单元的成员节点一起）基于现有的导管作为基础（不是直线距离）采用最小生成树计算后，沿着导管敷电源火线。
    2、对于每个非受控节点沿着电源火线向其配电箱节点找最短路径。在最短路径中，每段导线的电流 = 原导线电流 + 本电器节点的额定电流。
    **第三步：**
    对于每个受控单元：
    1、每个受控单元和其匹配的开关节点（即把匹配的开关节点添加到受控单元的成员节点一起）基于现有的导管作为基础（不是直线距离）采用最小生成树计算后，沿着导管敷设控制线。
    2、对于每个受控节点沿着控制线向其开关节点找最短路径。在最短路径中，每段导线的电流 = 原导线电流 + 本电器节点的额定电流。
    3、开关节点的额定电流等于其连接的控制线电流之和。
    **第四步：**
    1、各个开关节点就近原则查找电源火线经过节点或者配电箱节点引入电源，敷设电源火线。
    2、对于每个开关节点沿着电源火线向其配电箱节点找最短路径。在最短路径中，每段导线的电流 = 原导线电流 + 本电器节点的额定电流。
}
